{"version":3,"sources":["../../src/permission.js"],"names":["hasPermission","roles","permissionRoles","indexOf","some","role","whiteList","beforeEach","to","from","next","start","path","done","getters","length","dispatch","then","res","data","addRoutes","addRouters","catch","error","meta","query","noGoBack","afterEach"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;AACA;;AACA;;;;AAGA,SAASA,aAAT,CAAuBC,KAAvB,EAA8BC,eAA9B,EAA+C;AAC7C,MAAID,MAAME,OAAN,CAAc,OAAd,KAA0B,CAA9B,EAAiC,OAAO,IAAP;AACjC,MAAI,CAACD,eAAL,EAAsB,OAAO,IAAP;AACtB,SAAOD,MAAMG,IAAN,CAAW;AAAA,WAAQF,gBAAgBC,OAAhB,CAAwBE,IAAxB,KAAiC,CAAzC;AAAA,GAAX,CAAP;AACD;;AAGD,IAAMC,YAAY,CAAC,QAAD,EAAW,eAAX,CAAlB;AACA,iBAAOC,UAAP,CAAkB,UAACC,EAAD,EAAKC,IAAL,EAAWC,IAAX,EAAoB;AACpC,sBAAUC,KAAV;AACA,MAAI,qBAAJ,EAAgB;AACd,QAAIH,GAAGI,IAAH,KAAY,QAAhB,EAA0B;AACxBF,WAAK,EAAEE,MAAM,GAAR,EAAL;AACA,0BAAUC,IAAV;AACD,KAHD,MAGO;AACL,UAAI,gBAAMC,OAAN,CAAcb,KAAd,CAAoBc,MAApB,KAA+B,CAAnC,EAAsC;AACpC,wBAAMC,QAAN,CAAe,aAAf,EAA8BC,IAA9B,CAAmC,eAAO;AACxC,cAAMhB,QAAQiB,IAAIC,IAAJ,CAASd,IAAvB;AACA,0BAAMW,QAAN,CAAe,gBAAf,EAAiC,EAAEf,YAAF,EAAjC,EAA4CgB,IAA5C,CAAiD,YAAM;AACrD,6BAAOG,SAAP,CAAiB,gBAAMN,OAAN,CAAcO,UAA/B;AACAX,4CAAUF,EAAV;AACD,WAHD;AAID,SAND,EAMGc,KANH,CAMS,YAAM;AACb,0BAAMN,QAAN,CAAe,WAAf,EAA4BC,IAA5B,CAAiC,YAAM;AACrC,+BAAQM,KAAR,CAAc,YAAd;AACAb,iBAAK,EAAEE,MAAM,QAAR,EAAL;AACD,WAHD;AAID,SAXD;AAYD,OAbD,MAaO;AAEL,YAAIZ,cAAc,gBAAMc,OAAN,CAAcb,KAA5B,EAAmCO,GAAGgB,IAAH,CAAQnB,IAA3C,CAAJ,EAAsD;AACpDK;AACD,SAFD,MAEO;AACLA,eAAK,EAAEE,MAAM,MAAR,EAAgBa,OAAO,EAAEC,UAAU,IAAZ,EAAvB,EAAL;AACA,8BAAUb,IAAV;AACD;AAEF;AACF;AACF,GA7BD,MA6BO;AACL,QAAIP,UAAUH,OAAV,CAAkBK,GAAGI,IAArB,MAA+B,CAAC,CAApC,EAAuC;AACrCF;AACD,KAFD,MAEO;AACLA,WAAK,QAAL;AACA,0BAAUG,IAAV;AACD;AACF;AACF,CAvCD;;AAyCA,iBAAOc,SAAP,CAAiB,YAAM;AACrB,sBAAUd,IAAV;AACD,CAFD","file":"permission.js","sourcesContent":["import router from './router'\nimport store from './store'\nimport NProgress from 'nprogress' // Progress 进度条\nimport 'nprogress/nprogress.css'// Progress 进度条样式\nimport { getToken } from '@/utils/auth' // 验权\nimport { Message } from 'element-ui'\n\n// permissiom judge\nfunction hasPermission(roles, permissionRoles) {\n  if (roles.indexOf('admin') >= 0) return true // admin权限 直接通过\n  if (!permissionRoles) return true\n  return roles.some(role => permissionRoles.indexOf(role) >= 0)\n}\n\n// register global progress.\nconst whiteList = ['/login', '/authredirect']// 不重定向白名单\nrouter.beforeEach((to, from, next) => {\n  NProgress.start() // 开启Progress\n  if (getToken()) { // 判断是否有token\n    if (to.path === '/login') {\n      next({ path: '/' })\n      NProgress.done() // router在hash模式下 手动改变hash 重定向回来 不会触发afterEach 暂时hack方案 ps：history模式下无问题，可删除该行！\n    } else {\n      if (store.getters.roles.length === 0) { // 判断当前用户是否已拉取完user_info信息\n        store.dispatch('GetUserInfo').then(res => { // 拉取user_info\n          const roles = res.data.role\n          store.dispatch('GenerateRoutes', { roles }).then(() => { // 生成可访问的路由表\n            router.addRoutes(store.getters.addRouters) // 动态添加可访问路由表\n            next({ ...to }) // hack方法 确保addRoutes已完成\n          })\n        }).catch(() => {\n          store.dispatch('FedLogOut').then(() => {\n            Message.error('验证失败,请重新登录')\n            next({ path: '/login' })\n          })\n        })\n      } else {\n        // 没有动态改变权限的需求可直接next() 删除下方权限判断 ↓\n        if (hasPermission(store.getters.roles, to.meta.role)) {\n          next()//\n        } else {\n          next({ path: '/401', query: { noGoBack: true }})\n          NProgress.done() // router在hash模式下 手动改变hash 重定向回来 不会触发afterEach 暂时hack方案 ps：history模式下无问题，可删除该行！\n        }\n        // 可删 ↑\n      }\n    }\n  } else {\n    if (whiteList.indexOf(to.path) !== -1) { // 在免登录白名单，直接进入\n      next()\n    } else {\n      next('/login') // 否则全部重定向到登录页\n      NProgress.done() // router在hash模式下 手动改变hash 重定向回来 不会触发afterEach 暂时hack方案 ps：history模式下无问题，可删除该行！\n    }\n  }\n})\n\nrouter.afterEach(() => {\n  NProgress.done() // 结束Progress\n})\n"]}